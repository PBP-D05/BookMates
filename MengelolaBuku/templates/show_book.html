{% extends 'base.html' %}

{% block content %}
<style>
body{
    background: url('bg1.png');
    background-size: cover;
    background-color: #F3E8EA;
    max-width: 1096px;
}
.wrapper-title{
    margin: 30px;
    width: 95%;
    height: max-content;
}

#title{
    font-family: 'Kavoon';
    font-size: 40px;
    font-weight: 400;
    color: #45425A;
    align-items: start;
    max-width: 50%;
}

#add-book-button{
    position: absolute;
    right: 0;
    margin-right: 20px;
    background-color: #45425A;
    font-family: 'Kavoon';
    font-weight: 400;
    font-size: 16px;
    color: #FFFFFF;
    border-color: #45425A;
}

#wrapper-card{
    margin-top: 30px;
    max-width: 2000px;
    align-items: center;

}

.card{
    margin-top: 20px;
    margin-bottom: 20px;
    margin-left: 40px;
    margin-right: 5px;
    padding: 20px;
    
}

.card-text{
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    font-size: 20px;
    line-height: 19px;
    color: #000000;
    display: flex;
    margin-left: 50px;
}

.card-title{
    display: flex;
    font-family: 'Kavoon';
    font-style: normal;
    font-weight: 400;
    font-size: 28px;
    line-height: 29px;
    color: #45425A;
    margin-left: 50px;
}


#book-cover{
    width: 180px;
    height: 264px;
}
.ratings{
    margin-right:10px;
}

.ratings i{
    color:#D9D9D9;
    font-size:20px;
}

.rating-color{
    color: #FBC634 !important;
}

.remove-btn{
    background-color: transparent;
    border: none;
}

.details-btn{
    background-color: #45425A;
    font-family: 'Kavoon';
    font-weight: 300;
    font-size: 20px;
    color: #FFFFFF;
    margin-left: 50px;
    width: 106px;
    border-color: #45425A;
}

#header-modal{
    background-color: #FF6B6C;
    font-family: 'Kavoon';
    font-weight: 300;
    font-size: 20px;
    color: #45425A;
}

.modal-body{
    background-color: #F3E8EA;
}

.form-control{
    background-color: #E2D1D4;
    border-color: #E2D1D4;
}

.modal-footer{
    background-color: #F3E8EA;
}

#button_add{
    background-color: #45425A;
    font-family: 'Kavoon';
    font-weight: 400;
    font-size: 16px;
    color: #FFFFFF;
    border-color: #45425A;
}

.col-form-label{
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    font-size: 17px;
    line-height: 19px;
    color: #000000;
}
</style>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="header-modal">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Add Book</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="judul" class="col-form-label">Book Title</label>
                      <input type="text" class="form-control" id="judul" name="judul"></input>
                    </div>
                    <div class="mb-3">
                      <label for="author" class="col-form-label">Book Author</label>
                      <input type="text" class="form-control" id="author" name="author"></input>
                    </div>
                    <div class="mb-3">
                      <label for="age" class="col-form-label">Recommended Age</label>
                      <input type="number" class="form-control" id="min_age" name="min_age" min="1" max="13" placeholder="from"></input>
                      <input type="number" class="form-control" id="max_age" name="max_age" min="1" max="13" placeholder="until"></input>
                    </div>
                    <label for="customRange3" class="form-label">Rating</label>
                    <input type="range" class="form-range" min="0" max="5" step="0.5" id="customRange3" value="3" oninput="updateValueDisplay()">
                    <label id="range-value-text">3</label>
                    <div class="mb-3">
                        <label for="edit-num-rating" class="col-form-label">Reviewed by</label>
                        <input type="number" class="form-control" id="edit-num-rating" name="edit-min-age" min="0" max="1000" placeholder="how many peopla left comment here?"></input>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="col-form-label">Synopsis</label>
                        <textarea class="form-control" id="description" name="description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Add Product</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Book</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="edit-judul" class="col-form-label">Book Title</label>
                      <input type="text" class="form-control" id="edit-judul" name="edit-judul"></input>
                    </div>
                    <div class="mb-3">
                      <label for="edit-author" class="col-form-label">Book Author</label>
                      <input type="text" class="form-control" id="edit-author" name="edit-author"></input>
                    </div>
                    <div class="mb-3">
                      <label for="edit-age" class="col-form-label">Recommended Age</label>
                      <input type="number" class="form-control" id="edit-min-age" name="edit-min-age" min="1" max="13" placeholder="from"></input>
                      <input type="number" class="form-control" id="edit-max-age" name="edit-max-age" min="1" max="13" placeholder="until"></input>
                    </div>
                    <label for="edit-customRange3" class="form-label">Rating</label>
                    <input type="range" class="form-range" min="0" max="5" step="0.5" id="edit-customRange3" value="3" oninput="updateValueDisplay()">
                    <label id="edit-range-value-text">3</label>
                    <div class="mb-3">
                        <label for="edit-num-rating" class="col-form-label">Reviewed by</label>
                        <input type="number" class="form-control" id="edit-num-rating" name="edit-min-age" min="0" max="1000" placeholder="how many peopla left comment here?"></input>
                    </div>
                    <div class="mb-3">
                        <label for="edit-description" class="col-form-label">Synopsis</label>
                        <textarea class="form-control" id="edit-description" name="edit-description"></textarea>
                    </div>
                    <input type="hidden" id="original-edit-bookId" name="edit-bookId">
                    <input type="hidden" id="original-title" name="original-title">
                    <input type="hidden" id="original-author" name="original-author">
                    <input type="hidden" id="original-min-age" name="original-min-age">
                    <input type="hidden" id="original-max-age" name="original-max-age">
                    <input type="hidden" id="original-rating" name="original-rating">
                    <input type="hidden" id="original-num-rating" name="original-num-rating">
                    <input type="hidden" id="original-desc" name="original-desc">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="button_edit" data-bs-dismiss="modal">Edit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" id="detailModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" id="header-modal">
          <h5 class="modal-title">Book Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="hideModal()"></button>
        </div>
        <div class="modal-body" id="details-modal-body">
          <p>Modal body text goes here.</p>
        </div>
      </div>
    </div>
</div>

<div class="wrapper-title">
    <h1 id="title">My Books</h1>
    <button id="add-book-button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Add New Book</button>
</div>
<br>
<div id="wrapper-card" class="grid grid-cols-4 gap-4"></div>


<script>
    // $(document).ready(function() {
    //     $('#details-button').on('click', function() {
    //         const objectId = $(this).closest('.card').data('object-id');
    //         getBooksId(objectId);
    //     })
    // });

    async function getBooks() {
        return fetch("{% url 'MengelolaBuku:get_books_json' %}").then((res) => res.json())
    }

    async function getBooksId(objectId) {
        return fetch(`get-books-json-id/${objectId}`).then((res) => res.json())
    }

    async function refreshBooks() {
        document.getElementById("wrapper-card").innerHTML = ""
        const products = await getBooks()
        let htmlString = ""
        products.forEach((books) => {
            var book_rating = Math.round(books.fields.rating)
            var rating_kosong = 5 - book_rating
            var url_image = books.fields.image_url
            htmlString += `<div id="book-card" class="card col-6" style="width: 35rem;">
            <div class="card-body">
            <table>    
            <tr>
              <td rowspan="5"><img id="book-cover" src="${url_image}" alt="Book Cover"></td>
              <td colspan="2" id="title-wrapper"><h5 class="card-title">${books.fields.judul}</h5></td>
            </tr>
            <tr>
              <td colspan="2"><p class="card-text">Author      ${books.fields.author}</p></td>
            </tr>
            <tr>
              <td colspan="2">
              <p class="card-text">Age         ${books.fields.min_age}-${books.fields.max_age} years</p>
              </td>
            </tr>
            <tr>
              <td colspan="2">  
              <div class="ratings d-flex">
                <p class="card-text">${books.fields.rating}</p>
                <i class="fa fa-star rating-color"></i>
                <p class="card-text" style="margin-left: 20px;">(${books.fields.num_of_rating})</p>
              </div>
              </td>
            </tr>  
            <tr>
            <td><button class="btn btn-primary details-btn" id="details-button" onclick="showDetails(${books.pk})">Details</button></td>
            <td><a href="remove_all/{{item.pk}}/"><button class="btn remove-btn">🗑️</button></a></td>
            </tr>
            </table>
            </div>
            </div>` 
        })
        
        document.getElementById("wrapper-card").innerHTML = htmlString
    }
    
    refreshBooks()

    function addBook() {
        fetch("{% url 'MengelolaBuku:add_book' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshProducts)

        document.getElementById("form").reset()
        return false
    }
    document.getElementById("button_add").onclick = addBook

    async function showDetails(objectId){
        document.getElementById("details-modal-body").innerHTML = ""
        let htmlString = ""
        var books = await getBooksId(objectId)
        books = books[0]
        console.log(books)
        var url_image = books.fields.image_url
        htmlString += `
        <table>    
            <tr>
              <td rowspan="5"><img id="book-cover" src="${url_image}" alt="Book Cover"></td>
              <td colspan="2" id="title-wrapper"><h5 class="card-title">${books.fields.judul}</h5></td>
            </tr>
            <tr>
              <td><p class="card-text"><b>Author</b></p></td>
              <td><p class="card-text">${books.fields.author}</p></td>
            </tr>
            <tr>
              <td>
              <p class="card-text"><b>Age</b></p></td>
              <td><p class="card-text">${books.fields.min_age}-${books.fields.max_age} years</p></td>
            </tr>
            <tr>
                <td colspan="2><p class="card-text">${books.fields.desc}</p></td>
            </tr>
            <tr>
              <td colspan="2">  
              <div class="ratings d-flex">
                <p class="card-text">${books.fields.rating}</p>
                <i class="fa fa-star rating-color"></i>
                <p class="card-text" style="margin-left: 20px;">(${books.fields.num_of_rating})</p>
              </div>
              </td>
            </tr>
        </table>`
        document.getElementById("details-modal-body").innerHTML = htmlString
        document.getElementById('detailModal').style.display = "block";

    }

    function hideModal(){
        document.getElementById('detailModal').style.display = 'none';
    }

    function updateValueDisplay() {
        var rangeInput = document.getElementById('customRange3');
        document.getElementById('range-value-text').textContent = rangeInput.value;
    }

    function openEditModal(bookId, title, author, min_age, max_age, rating, num_of_rating, description) {
        // Store the original values when the modal is opened
        document.getElementById('original-edit-bookId').value = bookId
        document.getElementById('original-title').value = title;
        document.getElementById('original-author').value = author;
        document.getElementById('original-min-age').value = min_age;
        document.getElementById('original-max-age').value = max_age;
        document.getElementById('original-rating').value = rating;
        document.getElementById('original-num-rating').value = num_of_rating;
        document.getElementById('original-desc').value = desc;


        // Populate the input fields with current values
        document.getElementById('edit-bookId').value = bookId
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-author').value = author;
        document.getElementById('edit-min-age').value = min_age;
        document.getElementById('edit-max-age').value = max_age;
        document.getElementById('edit-rating').value = rating;
        document.getElementById('edit-num-rating').value = num_of_rating;
        document.getElementById('edit-desc').value = desc;

        // Open the modal
        document.getElementById('#editModal').showPopover;
    }

    function submitEditForm() {
        // Get the values from the form
        var bookId = document.getElementById('edit-bookId').value;
        var newTitle = document.getElementById('edit-title').value;
        var newAuthor = document.getElementById('edit-author').value;
        var newMinimal_age = document.getElementById('edit-min-age').value;
        var newMaximal_age = document.getElementById('edit-max-age').value;
        var newRating = document.getElementById('edit-rating').value;
        var newNumRating = document.getElementById('edit-num-rating').value;
        var newDesc = document.getElementById('edit-desc').value;

        // Get the original values
        var originalTitle = document.getElementById('original-edit-bookId').value;
        var originalAuthor = document.getElementById('original-author').value;
        var originalMinAge = document.getElementById('original-min-age').value;
        var originalMaxAge = document.getElementById('original-max-age').value;
        var originalRating = document.getElementById('original-rating').value;
        var originalNumRating = document.getElementById('original-num-rating').value;
        var originalDesc = document.getElementById('original-desc').value;


        // Check if changes have been made
        if (newTitle !== originalTitle || newAuthor !== originalAuthor || newMinimal_age !== originalMinAge || newAuthor !== originalAuthor || 
        newMaximal_age !== originalMaxAge || newRating !== originalRating || newNumRating !== originalNumRating || newDesc !== originalDesc  /* || check other fields */) {
            // Changes have been made, proceed with updating the book
            // Make a request to update the book using JavaScript or send the data to Django views
            // ...
            $.ajax({
            type: 'POST',
            url: '/update_book/',  // Update this URL based on your Django views configuration
            data: {
                'book_id': bookId,
                'new_title': newTitle,
                'new_author': newAuthor,
                'new_min_age': newMinimal_age,
                'new_max_age': newMaximal_age,
                'new_rating': newRating,
                'new_num_rating': newNumRating,
                'new_synopsis': newDesc,
            },
            success: function (data) {
                // Handle success (e.g., close the modal, refresh the book list)
                $('#editModal').modal('hide');
                refreshBooks();  // Call your function to refresh the book list
            },
            error: function (error) {
                // Handle error
                console.error('Error updating book:', error);
            }
        });
        }

        // Close the modal
        $('#editModal').modal('hide');
    }
</script>

{% endblock content %}